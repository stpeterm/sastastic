import common.utils;                                                                                                                                                                                                                                            
import sashelp.classes;                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                
class _docdb;                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                
private char name / (state='O', initialValue = '_docdb');                                                                                                                                                                                                       
public  char lib  / (initialValue = 'work');                                                                                                                                                                                                                    
public  char cat  / (initialValue = '_docdb');                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                
public _excp excp ;                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                
_docdb : method / (state='O');                                                                                                                                                                                                                                  
      excp = _new_ _excp();                                                                                                                                                                                                                                     
endmethod;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                
_docdb : method lib_in : i : char;                                                                                                                                                                                                                              
      excp = _new_ _excp();                                                                                                                                                                                                                                     
      _self_.lib = lib_in;                                                                                                                                                                                                                                      
endmethod;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
create : method                                                                                                                                                                                                                                                 
   optional=                                                                                                                                                                                                                                                    
      custom  : i : list                                                                                                                                                                                                                                        
      libname : i : char                                                                                                                                                                                                                                        
   return=object                                                                                                                                                                                                                                                
   ;                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                
   control asis;                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                
   *dcl sclexception.class excp = _new_ sclexception();                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                
   * assign the libname on the fly ;                                                                                                                                                                                                                            
   if cmiss(libname) then libname = _self_.lib; else _self_.lib = libname;                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
   * for expanding the custom argument ;                                                                                                                                                                                                                        
   if cmiss(custom) then custom = makelist();                                                                                                                                                                                                                   
   dcl list custom_var   = getniteml(custom,'var',1,1,makelist());                                                                                                                                                                                              
   dcl list custom_ic    = getniteml(custom,'ic',1,1,makelist());                                                                                                                                                                                               
   dcl list custom_index = getniteml(custom,'index',1,1,makelist());                                                                                                                                                                                            
                                                                                                                                                                                                                                                                
   dcl char custom_var_j                                                                                                                                                                                                                                        
            custom_ic_j                                                                                                                                                                                                                                         
            custom_index_j;                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                
   dcl num rc j;                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                
   do ;                                                                                                                                                                                                                                                         
      put name _method_ 'START';                                                                                                                                                                                                                                
      * verify that the register doesn't _already_ exist. don't overwrite it if it does;                                                                                                                                                                        
      if exist(catx('.',libname,'_docdb_register')) then do;                                                                                                                                                                                                    
         excp.message = 'ERROR: docdb register already exists.';                                                                                                                                                                                                
         throw excp;                                                                                                                                                                                                                                            
      end;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
      * create the register;                                                                                                                                                                                                                                    
      submit;                                                                                                                                                                                                                                                   
         data &libname._docdb_register;                                                                                                                                                                                                                         
             attrib                                                                                                                                                                                                                                             
      endsubmit;                                                                                                                                                                                                                                                
      * allow for custom variables for whatever database is expected - put them first in the ;                                                                                                                                                                  
      * submitted ATTRIB statement as they will usually be more relevant than the base fields;                                                                                                                                                                  
      do j = 1 to listlen(custom_var);                                                                                                                                                                                                                          
         custom_var_j = getitemc(custom_var,j);                                                                                                                                                                                                                 
         submit; &custom_var_j endsubmit;                                                                                                                                                                                                                       
      end;                                                                                                                                                                                                                                                      
      * these are the base fields expected by docdb and should not change ;                                                                                                                                                                                     
      submit continue;                                                                                                                                                                                                                                          
                 _description      length=$64  format=$64.          label='description'                                                                                                                                                                         
                 _userid           length=$16  format=$16.          label='user id'                                                                                                                                                                             
                 _datetime         length=8    format=datetime20.3  label='datetime added'                                                                                                                                                                      
                 _doc              length=$83  format=$83.          label='document'                                                                                                                                                                            
                 _version          length=8    format=z4.           label='version'                                                                                                                                                                             
                 _id               length=$16  format=hex32.        label='id'                                                                                                                                                                                  
                 _previous_id      length=$16  format=hex32.        label='id of previous version'                                                                                                                                                              
             ;                                                                                                                                                                                                                                                  
             stop;                                                                                                                                                                                                                                              
         run;                                                                                                                                                                                                                                                   
      endsubmit;                                                                                                                                                                                                                                                
      * if something went wrong, delete the file and bail.;                                                                                                                                                                                                     
      if symgetn('syserr') > 0 then do;                                                                                                                                                                                                                         
         rc = delete(catx('.',libname,'_docdb_register'));                                                                                                                                                                                                      
         call putlist(custom_var,catx(' ',name,_method_,'ERROR: Custom Vars supplied='),0);                                                                                                                                                                     
         excp.message = 'ERROR in creation of dataset';                                                                                                                                                                                                         
         throw excp;                                                                                                                                                                                                                                            
      end;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
      * now, add integrity constraints (and the primary key of id);                                                                                                                                                                                             
      submit;                                                                                                                                                                                                                                                   
         proc datasets nolist lib=&lib;                                                                                                                                                                                                                         
            modify _docdb_register;                                                                                                                                                                                                                             
               ic create id_prim          = primary key (_id);                                                                                                                                                                                                  
               ic create must_have_id     = not null (_id);                                                                                                                                                                                                     
               ic create must_have_ver    = not null (_version);                                                                                                                                                                                                
               ic create must_have_prev   = not null (_previous_id);                                                                                                                                                                                            
               ic create must_have_desc   = not null (_description);                                                                                                                                                                                            
               ic create must_have_doc    = not null (_doc);                                                                                                                                                                                                    
               ic create must_have_userid = not null (_userid);                                                                                                                                                                                                 
               ic create must_have_dt     = not null (_datetime);                                                                                                                                                                                               
      endsubmit;                                                                                                                                                                                                                                                
      * add any custom integrity constraints passed in;                                                                                                                                                                                                         
      do j = 1 to listlen(custom_ic);                                                                                                                                                                                                                           
         custom_ic_j = getitemc(custom_ic,j);                                                                                                                                                                                                                   
         submit; ic create &custom_ic_j; endsubmit;                                                                                                                                                                                                             
      end;                                                                                                                                                                                                                                                      
      submit continue;                                                                                                                                                                                                                                          
            run;                                                                                                                                                                                                                                                
         quit;                                                                                                                                                                                                                                                  
      endsubmit;                                                                                                                                                                                                                                                
      * bail if it doesn't fly;                                                                                                                                                                                                                                 
      if symgetn('syserr') > 0 then do;                                                                                                                                                                                                                         
         rc = delete(catx('.',libname,'_docdb_register'));                                                                                                                                                                                                      
         call putlist(custom_ic,catx(' ',name,_method_,'ERROR: Custom IC supplied='),0);                                                                                                                                                                        
         excp.message = 'ERROR in creation of integrity constraints';                                                                                                                                                                                           
         throw excp;                                                                                                                                                                                                                                            
      end;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
      * finally, add indices - the two are the bare min expected by docdb, then custom ;                                                                                                                                                                        
      submit;                                                                                                                                                                                                                                                   
         proc datasets nolist lib=&lib;                                                                                                                                                                                                                         
            modify _docdb_register;                                                                                                                                                                                                                             
               /* there was a '/ unique' modifier on the _previous_id index - but that's */                                                                                                                                                                     
               /* no longer the case - allows for templates and forks                    */                                                                                                                                                                     
               index create _previous_id;                                                                                                                                                                                                                       
               index create _userid;                                                                                                                                                                                                                            
               index create _datetime;                                                                                                                                                                                                                          
      endsubmit;                                                                                                                                                                                                                                                
      * add any custom integrity constraints passed in;                                                                                                                                                                                                         
      do j = 1 to listlen(custom_index);                                                                                                                                                                                                                        
         custom_index_j = getitemc(custom_index,j);                                                                                                                                                                                                             
         submit; index create &custom_index_j; endsubmit;                                                                                                                                                                                                       
      end;                                                                                                                                                                                                                                                      
      submit continue;                                                                                                                                                                                                                                          
            run;                                                                                                                                                                                                                                                
         quit;                                                                                                                                                                                                                                                  
      endsubmit;                                                                                                                                                                                                                                                
      * bail if it doesn't fly;                                                                                                                                                                                                                                 
      if symgetn('syserr') > 0 then do;                                                                                                                                                                                                                         
         rc = delete(catx('.',libname,'_docdb_register'));                                                                                                                                                                                                      
         call putlist(custom_index,catx(' ',name,_method_,'ERROR: Custom Indices supplied='),0);                                                                                                                                                                
         excp.message = 'ERROR in creation of integrity constraints';                                                                                                                                                                                           
         throw excp;                                                                                                                                                                                                                                            
      end;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
      * normal end;                                                                                                                                                                                                                                             
      rc = dellist(custom_var);                                                                                                                                                                                                                                 
      rc = dellist(custom_ic);                                                                                                                                                                                                                                  
      rc = dellist(custom_index);                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                
      put name _method_ 'END';                                                                                                                                                                                                                                  
      return(_self_);                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                
      catch excp;                                                                                                                                                                                                                                               
         put name _method_ 'ABEND';                                                                                                                                                                                                                             
         excp.capture(catx(' ',name,_method_));                                                                                                                                                                                                                 
         excp.message = catx(' ',name,_method_,'ERROR');                                                                                                                                                                                                        
         throw excp;                                                                                                                                                                                                                                            
      endcatch;                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                
   end;                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                
endmethod;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
info : method                                                                                                                                                                                                                                                   
   id : i : char                                                                                                                                                                                                                                                
   return=list                                                                                                                                                                                                                                                  
   ;                                                                                                                                                                                                                                                            
   dcl char libn = _self_.lib;                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                
   *dcl sclexception.class excp = _new_ sclexception();                                                                                                                                                                                                         
   dcl _list.class        ls   = _new_ _list();                                                                                                                                                                                                                 
   dcl num rc;                                                                                                                                                                                                                                                  
   dcl list outlist;                                                                                                                                                                                                                                            
   do;                                                                                                                                                                                                                                                          
      put name _method_ 'START';                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                
      submit sql;                                                                                                                                                                                                                                               
         create table _docdb_current_info as                                                                                                                                                                                                                    
         select *                                                                                                                                                                                                                                               
         from &libn._docdb_register                                                                                                                                                                                                                             
      endsubmit;                                                                                                                                                                                                                                                
      select(length(id));                                                                                                                                                                                                                                       
         when(16) id=put(id,$hex32.);                                                                                                                                                                                                                           
         when(32) ;                                                                                                                                                                                                                                             
         otherwise do;                                                                                                                                                                                                                                          
            rc = preview('clear');                                                                                                                                                                                                                              
            put name _method_ 'ERROR: Strange length of id=' id;                                                                                                                                                                                                
            excp.message = 'ERROR: ID does not appear to be valid';                                                                                                                                                                                             
            throw excp;                                                                                                                                                                                                                                         
         end;                                                                                                                                                                                                                                                   
      end;                                                                                                                                                                                                                                                      
      submit sql continue; where _id = '&id'x; endsubmit;                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                
      rc = symgetn('sqlrc');                                                                                                                                                                                                                                    
      if rc > 0 then do;                                                                                                                                                                                                                                        
         put name _method_ 'ERROR: SQL issue. Return code is' rc ', sqlobs =' ;                                                                                                                                                                                 
         excp.message = catx(' ','ERROR: SQL rc =',rc,', message is',sysmsg());                                                                                                                                                                                 
         throw excp;                                                                                                                                                                                                                                            
      end;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
      * fail if sqlobs is 0;                                                                                                                                                                                                                                    
      rc = symgetn('sqlobs');                                                                                                                                                                                                                                   
      if rc = 0 then do;                                                                                                                                                                                                                                        
         put name _method_ 'ERROR: Could not find' id;                                                                                                                                                                                                          
         excp.message = catx(' ','ERROR: SQL for ID',id,'returned zero obs');                                                                                                                                                                                   
         throw excp;                                                                                                                                                                                                                                            
      end;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
      * normal end;                                                                                                                                                                                                                                             
      put name _method_ 'END';                                                                                                                                                                                                                                  
      * the create_list method will return a nested list. strip out the nesting;                                                                                                                                                                                
      outlist = getiteml(ls.create_list('_docdb_current_info'));                                                                                                                                                                                                
      return(outlist);                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                
      * abnormal end;                                                                                                                                                                                                                                           
      catch excp;                                                                                                                                                                                                                                               
         put name _method_ 'ABEND';                                                                                                                                                                                                                             
         excp.capture(catx(' ',name,_method_));                                                                                                                                                                                                                 
         excp.message = catx(' ',name,_method_);                                                                                                                                                                                                                
         throw excp;                                                                                                                                                                                                                                            
      endcatch;                                                                                                                                                                                                                                                 
   end;                                                                                                                                                                                                                                                         
endmethod;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
select : method                                                                                                                                                                                                                                                 
   id : i : char                                                                                                                                                                                                                                                
   optional=                                                                                                                                                                                                                                                    
      nocontents : i : char                                                                                                                                                                                                                                     
   return = list;                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                
   dcl char libn = _self_.lib;                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                
   *dcl sclexception.class excp = _new_ sclexception();                                                                                                                                                                                                         
   dcl _list.class        ls   = _new_ _list();                                                                                                                                                                                                                 
   dcl num rc;                                                                                                                                                                                                                                                  
   dcl list outlist;                                                                                                                                                                                                                                            
   dcl char docn;             *doc name;                                                                                                                                                                                                                        
   dcl list docc = ls.make(); *doc contents;                                                                                                                                                                                                                    
   put name _method_ 'START';                                                                                                                                                                                                                                   
   do;                                                                                                                                                                                                                                                          
      * get the base-level info: in particular, also get the document's location;                                                                                                                                                                               
      * _self_.info is exception-enabled ;                                                                                                                                                                                                                      
      do;                                                                                                                                                                                                                                                       
         outlist = _self_.info(id); *call putlist(outlist,'current outlist=',0);                                                                                                                                                                                
         docn = getnitemc(outlist,'_doc');                                                                                                                                                                                                                      
         catch excp;                                                                                                                                                                                                                                            
            excp.message = 'ERROR in DOCDB INFO method.';                                                                                                                                                                                                       
            throw excp;                                                                                                                                                                                                                                         
         endcatch;                                                                                                                                                                                                                                              
      end;                                                                                                                                                                                                                                                      
      * now, load the list specified by the document ;                                                                                                                                                                                                          
      * MSP 2014-12-24 : don't do this if nocontents is specified ;                                                                                                                                                                                             
      if cmiss(nocontents) then do;                                                                                                                                                                                                                             
         rc = fillist('catalog',docn,docc);                                                                                                                                                                                                                     
         if rc ne 0 then do;                                                                                                                                                                                                                                    
            excp.message = catx(' ','ERROR in fillist. DOCN is',docn,'Return code is',rc);                                                                                                                                                                      
            throw excp;                                                                                                                                                                                                                                         
         end;                                                                                                                                                                                                                                                   
         rc = insertl(outlist,docc,-1,'_contents');                                                                                                                                                                                                             
      end;                                                                                                                                                                                                                                                      
      * normal end;                                                                                                                                                                                                                                             
      put name _method_ 'END';                                                                                                                                                                                                                                  
      return(outlist);                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                
      * abnormal end ;                                                                                                                                                                                                                                          
      catch excp;                                                                                                                                                                                                                                               
         put name _method_ 'ABEND';                                                                                                                                                                                                                             
         excp.capture(catx(' ',name,_method_));                                                                                                                                                                                                                 
         excp.message = catx(' ',name,_method_,'ERROR');                                                                                                                                                                                                        
         throw excp;                                                                                                                                                                                                                                            
      endcatch;                                                                                                                                                                                                                                                 
   end;                                                                                                                                                                                                                                                         
endmethod;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
select : method                                                                                                                                                                                                                                                 
/* kind of a weird chaining construction - dunno if it'll be used */                                                                                                                                                                                            
   id : u : char                                                                                                                                                                                                                                                
   lo : u : list                                                                                                                                                                                                                                                
   return=object;                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                
   lo = _self_.select(id);                                                                                                                                                                                                                                      
   return(_self_);                                                                                                                                                                                                                                              
endmethod;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                
update : method                                                                                                                                                                                                                                                 
   info : i : list                                                                                                                                                                                                                                              
   return=list;                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                
endmethod;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
delete : method                                                                                                                                                                                                                                                 
   id : i : char                                                                                                                                                                                                                                                
   return=list;                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                
   *dcl sclexception.class excp = _new_ sclexception();                                                                                                                                                                                                         
   dcl list outlist;                                                                                                                                                                                                                                            
   dcl num rc;                                                                                                                                                                                                                                                  
   dcl char libn docn;                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                
   do;                                                                                                                                                                                                                                                          
      put name _method_ 'START';                                                                                                                                                                                                                                
      outlist = _self_.select(id);                                                                                                                                                                                                                              
      docn = getnitemc(outlist,'_doc',1,1,'_error_'); if docn = '_error_' then throw excp;                                                                                                                                                                      
      rc = delete(docn,'catalog');                                                                                                                                                                                                                              
      * MSP 2014-12-13 - there was an exception thrown if the catalog entry doesn't exist. ;                                                                                                                                                                    
      * After a bit of reflection, I think this is okay.                                   ;                                                                                                                                                                    
      * if rc ne 0 then throw excp;                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                
      libn = _self_.lib;                                                                                                                                                                                                                                        
      submit sql;                                                                                                                                                                                                                                               
         delete * from &libn._docdb_register                                                                                                                                                                                                                    
      endsubmit;                                                                                                                                                                                                                                                
      select(length(id));                                                                                                                                                                                                                                       
         when(16) submit sql; where id = quote(&id);  endsubmit;                                                                                                                                                                                                
         when(32) submit sql; where id = '&id'x; endsubmit;                                                                                                                                                                                                     
         otherwise do;                                                                                                                                                                                                                                          
            put name _method_ 'ERROR: Strange length of id=' id;                                                                                                                                                                                                
            excp.message = 'ERROR: ID does not appear to be valid';                                                                                                                                                                                             
            throw excp;                                                                                                                                                                                                                                         
         end;                                                                                                                                                                                                                                                   
      end;                                                                                                                                                                                                                                                      
      submit sql continue; endsubmit;                                                                                                                                                                                                                           
      if symgetn('sqlrc') > 0 then throw excp;                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                
      * normal end;                                                                                                                                                                                                                                             
      put name _method_ 'END';                                                                                                                                                                                                                                  
      return(outlist);                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                
      * abnormal end;                                                                                                                                                                                                                                           
      catch excp;                                                                                                                                                                                                                                               
         put name _method_ 'ABEND';                                                                                                                                                                                                                             
         excp.capture(catx(' ',name,_method_));                                                                                                                                                                                                                 
         excp.message = catx(' ',name,_method_,'ERROR');                                                                                                                                                                                                        
         throw excp;                                                                                                                                                                                                                                            
      endcatch;                                                                                                                                                                                                                                                 
   end;                                                                                                                                                                                                                                                         
endmethod;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
insert : method                                                                                                                                                                                                                                                 
/* adds an entry to the database */                                                                                                                                                                                                                             
   info : i : list                                                                                                                                                                                                                                              
   return=list                                                                                                                                                                                                                                                  
   ;                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                
   dcl num rc;                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                
   dcl _dataset.class     data = _new_ _dataset();                                                                                                                                                                                                              
   *dcl sclexception.class excp = _new_ sclexception();                                                                                                                                                                                                         
   dcl sclexception.class dele = _new_ sclexception();                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                
   dcl char libn = strip(_self_.lib);                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                
   dcl list contents  ;                                                                                                                                                                                                                                         
   dcl list nocontents;                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                
   dcl char dt      = put(datetime(),datetime20.3);                                                                                                                                                                                                             
   dcl char userid  = getnitemc(info,'_userid',1,1,symget('sysuserid'));                                                                                                                                                                                        
   dcl char desc    = getnitemc(info,'_description',1,1,'_none_');                                                                                                                                                                                              
   dcl char id      = getnitemc(info,'_id',1,1,md5(cats(dt,userid,desc)));                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
   * if the id begins with a numeric character then trying to directly save a catalog entry   ;                                                                                                                                                                 
   * with the id's value fails because it doesn't match SAS's guidelines for legit catalog    ;                                                                                                                                                                 
   * entry - so make it 'nice' by replacing the first character with an underscore. this will ;                                                                                                                                                                 
   * increase the chance of collision, but we're going to live with it                        ;                                                                                                                                                                 
   dcl char nice_id = put(id,$hex32.);                                                                                                                                                                                                                          
            nice_id = ifc(prxmatch('/\d/',first(nice_id)),cats('_',substr(nice_id,2)),nice_id);                                                                                                                                                                 
   dcl char docn    = getnitemc(info,'_doc',1,1,catx('.',_self_.lib,_self_.cat,nice_id,'SLIST'));                                                                                                                                                               
   dcl char docl    = scan(docn,1,'.');                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                
   do;                                                                                                                                                                                                                                                          
      put name _method_ 'START';                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                
      * baseline exception checking - make sure that library is assigned and that there is a reasonably ;                                                                                                                                                       
      * valid document slist path ;                                                                                                                                                                                                                             
      if libref(lib) ne 0 then do;                                                                                                                                                                                                                              
         put name _method_ 'ERROR: Lib is' libn;                                                                                                                                                                                                                
         excp.message = catx(' ','Library',lib,'is not assigned');                                                                                                                                                                                              
         throw excp;                                                                                                                                                                                                                                            
      end;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
      * also check that the libref we want to save to exists ;                                                                                                                                                                                                  
      if libref(docl) ne 0 then do;                                                                                                                                                                                                                             
         call putlist(info,catx(' ',name,_method_,'ERROR: Info to write='),0);                                                                                                                                                                                  
         excp.message = catx(' ',"Library',docl,'not assigned. Will not be able to save _doc.");                                                                                                                                                                
         throw excp;                                                                                                                                                                                                                                            
      end;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
      * if contents are specified, then check to see if the list already exists - if it does, throw an error ;                                                                                                                                                  
      * inversely, if there are no contents, check to see if the list exists - if it doesn't, throw an error ;                                                                                                                                                  
      contents = getniteml(info,'_contents',1,1,makelist());                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                
      if listlen(contents) > 0 and exist(docn,'catalog') then do;                                                                                                                                                                                               
         call putlist(info,catx(' ',name,_method_,'ERROR: Info to write='),0);                                                                                                                                                                                  
         excp.message = catx(' ','Document',docn,'already exists. Will not overwrite.');                                                                                                                                                                        
         throw excp;                                                                                                                                                                                                                                            
      end;                                                                                                                                                                                                                                                      
      else if listlen(contents) = 0 and ^exist(docn,'catalog') then do;    *call putlist(_self_,'obj is=',0);                                                                                                                                                   
         call putlist(info,catx(' ',name,_method_,'ERROR: Info to write='),0);                                                                                                                                                                                  
         excp.message = catx(' ','No new contents to write, and document to reference does not exist.');                                                                                                                                                        
         throw excp;                                                                                                                                                                                                                                            
      end;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
      * all right - made it past baseline error checks ;                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                
      * inspect the incoming list - add datetime at minimum. if user id isn't specified, add that as well;                                                                                                                                                      
      * create a single row like the existing database, then fill the row from the info list ;                                                                                                                                                                  
      rc = setnitemc(info,dt,'_datetime');                                                                                                                                                                                                                      
      rc = setnitemc(info,userid,'_userid');                                                                                                                                                                                                                    
      rc = setnitemc(info,id,'_id');                                                                                                                                                                                                                            
      rc = setnitemc(info,docn,'_doc');                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                
      submit sql continue;                                                                                                                                                                                                                                      
         create table work._docdb_to_add like &libn._docdb_register;                                                                                                                                                                                            
      endsubmit;                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                
      * data.write will fail with a nested list, which is exactly what contents is. make a copy of ;                                                                                                                                                            
      * the list and strip the contents before writing ;                                                                                                                                                                                                        
      nocontents = copylist(info);                                                                                                                                                                                                                              
      rc = delnitem(nocontents,'_contents');                                                                                                                                                                                                                    
      data.write(nocontents,'work._docdb_to_add');                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                
      submit sql continue;                                                                                                                                                                                                                                      
         insert into &libn._docdb_register                                                                                                                                                                                                                      
         select * from work._docdb_to_add;                                                                                                                                                                                                                      
      endsubmit;                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                
      if symgetn('sqlrc') > 0 then do;                                                                                                                                                                                                                          
         call putlist(info,catx(' ',name,_method_,'ERROR: Tried to append='),0);                                                                                                                                                                                
         excp.message = catx(' ','Problem with PROC APPEND onto register:',symget('syserrortext'));                                                                                                                                                             
         throw excp;                                                                                                                                                                                                                                            
      end;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                
      * actually save the 'document' to the slist specified if there are contents ;                                                                                                                                                                             
      if listlen(contents) > 0 then do;                                                                                                                                                                                                                         
         rc = savelist('catalog',docn,contents);                                                                                                                                                                                                                
         if rc ne 0 then do;                                                                                                                                                                                                                                    
            put name _method_ 'ERROR: Problem with SAVELIST on document itself. Attempting to delete';                                                                                                                                                          
            _self_.delete(getnitemc(info,'_id'));                                                                                                                                                                                                               
            catch dele;                                                                                                                                                                                                                                         
               put name _method_ 'ERROR: Delete failed too, somehow';                                                                                                                                                                                           
            endcatch;                                                                                                                                                                                                                                           
            excp.message = 'Problem with SAVELIST on document contents';                                                                                                                                                                                        
            throw excp;                                                                                                                                                                                                                                         
         end;                                                                                                                                                                                                                                                   
      end;                                                                                                                                                                                                                                                      
      * normal end;                                                                                                                                                                                                                                             
      * call putlist(info,catx(' ',name,_method_,'RETURNING='),0);                                                                                                                                                                                              
      return(info);                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                
      * abnormal end ;                                                                                                                                                                                                                                          
      catch excp;                                                                                                                                                                                                                                               
         put excp.message;                                                                                                                                                                                                                                      
         put name _method_ 'ABEND';                                                                                                                                                                                                                             
         excp.capture(catx(' ',name,_method_));                                                                                                                                                                                                                 
         excp.message = catx(' ',name,_method_,'ERROR');                                                                                                                                                                                                        
         throw excp;                                                                                                                                                                                                                                            
      endcatch;                                                                                                                                                                                                                                                 
   end;                                                                                                                                                                                                                                                         
endmethod;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
new : method                                                                                                                                                                                                                                                    
   newinfo: i : list                                                                                                                                                                                                                                            
   return=list;                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                
   *dcl sclexception.class excp = _new_ sclexception();                                                                                                                                                                                                         
   dcl num rc;                                                                                                                                                                                                                                                  
   dcl list outlist;                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                
   dcl char previous_id = '00000000000000000000000000000000'x;                                                                                                                                                                                                  
   dcl num  version     = 1;                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                
   do;                                                                                                                                                                                                                                                          
      * make sure there's a description, at least ;                                                                                                                                                                                                             
      if getnitemc(newinfo,'_description',1,1,'_none_') = '_none_' then do;                                                                                                                                                                                     
         call putlist(newinfo,catx(' ',name,_method_,'ERROR: no description provided'),0);                                                                                                                                                                      
         throw excp;                                                                                                                                                                                                                                            
      end;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
      * since it's new, put in some info that marks it as such;                                                                                                                                                                                                 
      rc = setnitemc(newinfo,previous_id,'_previous_id');                                                                                                                                                                                                       
      rc = setnitemn(newinfo,version,'_version');                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                
      * call insert ;                                                                                                                                                                                                                                           
      put name _method_ 'CALLING INSERT';                                                                                                                                                                                                                       
      outlist = _self_.insert(newinfo);                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                
      * normal end;                                                                                                                                                                                                                                             
      put name _method_ 'END';                                                                                                                                                                                                                                  
      return(outlist);                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                
      * abnormal end;                                                                                                                                                                                                                                           
      catch excp;                                                                                                                                                                                                                                               
         put name _method_ 'ABEND';                                                                                                                                                                                                                             
         excp.capture(catx(' ',name,_method_));                                                                                                                                                                                                                 
         excp.message = catx(' ',name,_method_,'ERROR');                                                                                                                                                                                                        
         throw excp;                                                                                                                                                                                                                                            
      endcatch;                                                                                                                                                                                                                                                 
   end;                                                                                                                                                                                                                                                         
endmethod;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
version : method                                                                                                                                                                                                                                                
   id        : i : char                                                                                                                                                                                                                                         
   new_info  : i : list                                                                                                                                                                                                                                         
   return=list;                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                
   *dcl sclexception.class excp = _new_ sclexception();                                                                                                                                                                                                         
   dcl list old_info = _self_.select(id,'nocontents');                                                                                                                                                                                                          
   dcl num rc;                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                
   * get attributes from the existing info list that will carry over to the new list ;                                                                                                                                                                          
   dcl char previous_id = getnitemc(old_info,'_id',1,1,'_error_');                                                                                                                                                                                              
   dcl num  new_version = getnitemn(old_info,'_version',1,1,-1)+1;                                                                                                                                                                                              
                                                                                                                                                                                                                                                                
   dcl list outlist;                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                
   do;                                                                                                                                                                                                                                                          
      * set the previous id and the new version on the new info list;                                                                                                                                                                                           
      rc = setnitemc(new_info,input(previous_id,$hex32.),'_previous_id');                                                                                                                                                                                       
      rc = setnitemn(new_info,new_version,'_version');                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                
      * and call insert;                                                                                                                                                                                                                                        
      put name _method_ 'CALLING INSERT';                                                                                                                                                                                                                       
      outlist = _self_.insert(new_info);                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                
      * and add it to the database ;                                                                                                                                                                                                                            
      put name _method_ 'END';                                                                                                                                                                                                                                  
      return(outlist);                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                
      * abnormal end;                                                                                                                                                                                                                                           
      catch excp;                                                                                                                                                                                                                                               
         put name _method_ 'ABEND';                                                                                                                                                                                                                             
         excp.capture(catx(' ',name,_method_));                                                                                                                                                                                                                 
         excp.message = catx(' ',name,_method_,'ERROR');                                                                                                                                                                                                        
         throw excp;                                                                                                                                                                                                                                            
      endcatch;                                                                                                                                                                                                                                                 
   end;                                                                                                                                                                                                                                                         
endmethod;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                
version : method                                                                                                                                                                                                                                                
   new_info  : i : list                                                                                                                                                                                                                                         
   return=list;                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                
   *dcl sclexception.class excp = _new_ sclexception();                                                                                                                                                                                                         
   dcl num rc;                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                
   * get attributes from the existing info list that will carry over to the new list ;                                                                                                                                                                          
   dcl char previous_id = getnitemc(new_info,'_id',1,1,'_error_');                                                                                                                                                                                              
   dcl num  new_version = getnitemn(new_info,'_version',1,1,-1)+1;                                                                                                                                                                                              
                                                                                                                                                                                                                                                                
   dcl list outlist;                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                
   do;                                                                                                                                                                                                                                                          
      if previous_id = '_error_' then do;                                                                                                                                                                                                                       
         *put name _method_ 'ERROR: No current ID found on input list';                                                                                                                                                                                         
         excp.message = 'ERROR: No current ID foudn on input list';                                                                                                                                                                                             
         throw excp;                                                                                                                                                                                                                                            
      end;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
      * delete the current id, set the previous id and the new version on the new info list;                                                                                                                                                                    
      rc = delnitem(new_info,'_id');                                                                                                                                                                                                                            
      rc = setnitemc(new_info,previous_id,'_previous_id');                                                                                                                                                                                                      
      rc = setnitemn(new_info,new_version,'_version');                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                
      * and call insert;                                                                                                                                                                                                                                        
      put name _method_ 'CALLING INSERT';                                                                                                                                                                                                                       
      outlist = _self_.insert(new_info);                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                
      * and add it to the database ;                                                                                                                                                                                                                            
      put name _method_ 'END';                                                                                                                                                                                                                                  
      return(outlist);                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                
      * abnormal end;                                                                                                                                                                                                                                           
      catch excp;                                                                                                                                                                                                                                               
         put name _method_ 'ABEND';                                                                                                                                                                                                                             
         excp.capture(catx(' ',name,_method_));                                                                                                                                                                                                                 
         excp.message = catx(' ',name,_method_,'ERROR');                                                                                                                                                                                                        
         throw excp;                                                                                                                                                                                                                                            
      endcatch;                                                                                                                                                                                                                                                 
   end;                                                                                                                                                                                                                                                         
endmethod;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                
current : method                                                                                                                                                                                                                                                
   id : i : char                                                                                                                                                                                                                                                
   return = list;                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                
   dcl char libn = _self_.lib;                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                
   *dcl sclexception.class excp = _new_ sclexception();                                                                                                                                                                                                         
   dcl _list.class        ls   = _new_ _list();                                                                                                                                                                                                                 
   dcl num rc;                                                                                                                                                                                                                                                  
   dcl list outlist;                                                                                                                                                                                                                                            
   dcl char docn; *doc name;                                                                                                                                                                                                                                    
   dcl list docc = ls.make(); *doc contents;                                                                                                                                                                                                                    
   do;                                                                                                                                                                                                                                                          
      submit sql;                                                                                                                                                                                                                                               
         select * into _docdb_current_info                                                                                                                                                                                                                      
         from &libn._docdb_register                                                                                                                                                                                                                             
      endsubmit;                                                                                                                                                                                                                                                
      select(length(id));                                                                                                                                                                                                                                       
         when(16) submit sql; where id = quote(&id);  endsubmit;                                                                                                                                                                                                
         when(32) submit sql; where id = '&id'x; endsubmit;                                                                                                                                                                                                     
         otherwise do;                                                                                                                                                                                                                                          
            put name _method_ 'ERROR: Strange length of id=' id;                                                                                                                                                                                                
            throw excp;                                                                                                                                                                                                                                         
         end;                                                                                                                                                                                                                                                   
      end;                                                                                                                                                                                                                                                      
      submit sql continue; endsubmit;                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                
      outlist = ls.create_list('_docdb_current_info');                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                
      docn = getnitemc(outlist,'_doc');                                                                                                                                                                                                                         
      rc = fillist('catalog',docn,docc); if rc ne 0 then throw excp;                                                                                                                                                                                            
      rc = insertl(outlist,docc,-1,'_contents');                                                                                                                                                                                                                
      return(outlist);                                                                                                                                                                                                                                          
      catch excp;                                                                                                                                                                                                                                               
         excp.capture(catx(' ',name,_method_));                                                                                                                                                                                                                 
         excp.message = catx(' ',name,_method_,'ERROR');                                                                                                                                                                                                        
         throw excp;                                                                                                                                                                                                                                            
      endcatch;                                                                                                                                                                                                                                                 
   end;                                                                                                                                                                                                                                                         
endmethod;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                
current_version : method                                                                                                                                                                                                                                        
   id : i : char                                                                                                                                                                                                                                                
   return=num;                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                
   * provide a way to give either the hex or the direct character representation;                                                                                                                                                                               
   dcl char libn = _self_.lib;                                                                                                                                                                                                                                  
   dcl num  ver;                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                
   *dcl sclexception.class excp = _new_ sclexception();                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                
   do;                                                                                                                                                                                                                                                          
      call symdel('_docdb_id_version');                                                                                                                                                                                                                         
      submit sql;                                                                                                                                                                                                                                               
         select _version into :_docdb_id_version                                                                                                                                                                                                                
         from &libn._docdb_register                                                                                                                                                                                                                             
      endsubmit;                                                                                                                                                                                                                                                
      select(length(id));                                                                                                                                                                                                                                       
         when(16) submit sql; where id = quote(&id);  endsubmit;                                                                                                                                                                                                
         when(32) submit sql; where id = '&id'x; endsubmit;                                                                                                                                                                                                     
         otherwise do;                                                                                                                                                                                                                                          
            put name _method_ 'ERROR: Strange length of id=' id;                                                                                                                                                                                                
            throw excp;                                                                                                                                                                                                                                         
         end;                                                                                                                                                                                                                                                   
      end;                                                                                                                                                                                                                                                      
      submit sql continue; endsubmit;                                                                                                                                                                                                                           
      * open question : should we throw an exception here if nothing is returned,  ;                                                                                                                                                                            
      * or allow it to happen ?                                                    ;                                                                                                                                                                            
                                                                                                                                                                                                                                                                
      ver = symgetn('_docdb_id_version');                                                                                                                                                                                                                       
      call symdel('_docdb_id_version');                                                                                                                                                                                                                         
      return(ver);                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                
      catch excp;                                                                                                                                                                                                                                               
         put name _method_ 'ABEND';                                                                                                                                                                                                                             
         excp.capture(catx(' ',name,_method_));                                                                                                                                                                                                                 
         excp.message = catx(' ',name,_method_,'ERROR');                                                                                                                                                                                                        
         throw excp;                                                                                                                                                                                                                                            
      endcatch;                                                                                                                                                                                                                                                 
   end;                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                
endmethod;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
find : method                                                                                                                                                                                                                                                   
   clauses     : i : list                                                                                                                                                                                                                                       
   optional =                                                                                                                                                                                                                                                   
      options : i : list                                                                                                                                                                                                                                        
   return=list;                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                
   dcl char libn = _self_.lib;                                                                                                                                                                                                                                  
   dcl list group_by = makelist();                                                                                                                                                                                                                              
   dcl char comma;                                                                                                                                                                                                                                              
   dcl char group_by_var group_by_comma group_by_on ;                                                                                                                                                                                                           
   dcl num get_info get_all;                                                                                                                                                                                                                                    
   dcl char current_all info_opt;                                                                                                                                                                                                                               
   dcl num j k rc;                                                                                                                                                                                                                                              
   dcl char thisClause;                                                                                                                                                                                                                                         
   dcl list outlist;                                                                                                                                                                                                                                            
   dcl _list.class lc = _new_ _list();                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                
   if cmiss(options) = 0 then do;                                                                                                                                                                                                                               
      group_by    = getniteml(options,'group_by',1,1,makelist());                                                                                                                                                                                               
      k = listlen(group_by);                                                                                                                                                                                                                                    
      do j = 1 to k;                                                                                                                                                                                                                                            
         comma = ifc(j<k,',',''); put comma=;                                                                                                                                                                                                                   
         group_by_var   = getitemc(group_by,j);                                                                                                                                                                                                                 
         group_by_comma = catx(' ',group_by_comma,group_by_var,comma);                                                                                                                                                                                          
         group_by_on    = catx(' ',group_by_on,'a.'||group_by_var,'=','b.'||group_by_var,'and')||' ';                                                                                                                                                           
         put group_by_var= group_by_comma= group_by_on=;                                                                                                                                                                                                        
      end;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
      current_all = getnitemc(options,'which',1,1,'current');                                                                                                                                                                                                   
      get_all     = ifn(first(lowcase(current_all))='a',1,0);                                                                                                                                                                                                   
      info_opt    = getnitemc(options,'info',1,1,'f');                                                                                                                                                                                                          
      get_info    = ifn(first(upcase(info_opt))='T',1,0);                                                                                                                                                                                                       
   end;                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                
   put name _method_ 'START';                                                                                                                                                                                                                                   
   do;                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                
      submit sql;                                                                                                                                                                                                                                               
         create table _docdbFind as                                                                                                                                                                                                                             
         select * from &libn._docdb_register where                                                                                                                                                                                                              
      endsubmit;                                                                                                                                                                                                                                                
      do j = 1 to listlen(clauses);                                                                                                                                                                                                                             
         thisClause = getitemc(clauses,j);                                                                                                                                                                                                                      
         submit sql;                                                                                                                                                                                                                                            
            &thisClause                                                                                                                                                                                                                                         
         endsubmit;                                                                                                                                                                                                                                             
      end;                                                                                                                                                                                                                                                      
      submit sql continue;                                                                                                                                                                                                                                      
         ;                                                                                                                                                                                                                                                      
      endsubmit;                                                                                                                                                                                                                                                
      if symgetn('sqlrc') > 0 then do;                                                                                                                                                                                                                          
         excp.message = 'ERROR: '||symget('syserrortext');                                                                                                                                                                                                      
         throw excp;                                                                                                                                                                                                                                            
       end;                                                                                                                                                                                                                                                     
       call putlist(group_by,'group_by=',0);                                                                                                                                                                                                                    
      if symgetn('sqlobs') > 1 and listlen(group_by) and ^get_all then do;                                                                                                                                                                                      
         submit sql;                                                                                                                                                                                                                                            
            create table _docdbFindCurrent as                                                                                                                                                                                                                   
            select a.* from _docdbFind a inner join (                                                                                                                                                                                                           
               select &group_by_comma, max(_version) as _version                                                                                                                                                                                                
               from _docdbFind                                                                                                                                                                                                                                  
               group by &group_by_comma                                                                                                                                                                                                                         
            ) b                                                                                                                                                                                                                                                 
            on &group_by_on a._version=b._version                                                                                                                                                                                                               
            ;                                                                                                                                                                                                                                                   
         endsubmit;                                                                                                                                                                                                                                             
         submit sql continue; ; endsubmit;                                                                                                                                                                                                                      
         if symgetn('sqlrc') > 0 then do;                                                                                                                                                                                                                       
            excp.message = 'ERROR: '||symget('syserrortext');                                                                                                                                                                                                   
            throw excp;                                                                                                                                                                                                                                         
         end;                                                                                                                                                                                                                                                   
      end;                                                                                                                                                                                                                                                      
      else do;                                                                                                                                                                                                                                                  
         rc=copy('work._docdbFind','work._docdbFindCurrent');                                                                                                                                                                                                   
      end;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
      outlist = lc.create_list('work._docdbFindCurrent');                                                                                                                                                                                                       
      return outlist;                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                
      catch excp;                                                                                                                                                                                                                                               
         put name _method_ 'ABEND';                                                                                                                                                                                                                             
         excp.capture(catx(' ',name,_method_));                                                                                                                                                                                                                 
         excp.message = catx(' ',name,_method_,'ERROR');                                                                                                                                                                                                        
         throw excp;                                                                                                                                                                                                                                            
      endcatch;                                                                                                                                                                                                                                                 
   end;                                                                                                                                                                                                                                                         
endmethod;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
endclass;
