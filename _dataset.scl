class _dataset;                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                
/* date regex that determines when to try to input a character-represented date/time into its   */                                                                                                                                                              
/* numeric representation - is used a couple of places when looking against a variable's format */                                                                                                                                                              
private char datetime_regex / (initialValue = '/(DATE|TIME|HHMM|ANYDT|8601)/');                                                                                                                                                                                 
                                                                                                                                                                                                                                                                
event 'column length changed'  / (method = 'alter_table', send='Manual');                                                                                                                                                                                       
                                                                                                                                                                                                                                                                
/*                                                                                                                                                                                                                                                              
eventhandler eh_hm / (sender = '_self_', event = 'column length changed');                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
eh_hm : method dsn : i : char blar : i : list;                                                                                                                                                                                                                  
   dcl list metadata;                                                                                                                                                                                                                                           
   dcl num rc;                                                                                                                                                                                                                                                  
 *blar : i : object;                                                                                                                                                                                                                                            
 put 'in eh--------------------------------';                                                                                                                                                                                                                   
 call putlist(blar,dsn||'=',0);                                                                                                                                                                                                                                 
 put blar=;                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                
endmethod;                                                                                                                                                                                                                                                      
*/                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                
/* alter_table takes a list of alteration instructions, submits them to sql, and returns the sqlrc */                                                                                                                                                           
alter_table : method                                                                                                                                                                                                                                            
   ds   : i : char                                                                                                                                                                                                                                              
   alts : i : list                                                                                                                                                                                                                                              
   optional =                                                                                                                                                                                                                                                   
      prev : i : char                                                                                                                                                                                                                                           
   return=num                                                                                                                                                                                                                                                   
   ;                                                                                                                                                                                                                                                            
   control asis;                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                
   dcl char thisAlt;                                                                                                                                                                                                                                            
   dcl num i rc;                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                
   submit sql;                                                                                                                                                                                                                                                  
      alter table &ds                                                                                                                                                                                                                                           
   endsubmit;                                                                                                                                                                                                                                                   
   do i = 1 to listlen(alts);                                                                                                                                                                                                                                   
      thisAlt = getitemc(alts,i);                                                                                                                                                                                                                               
      submit sql; &thisAlt endsubmit;                                                                                                                                                                                                                           
   end;                                                                                                                                                                                                                                                         
   if cmiss(prev) = 0 then rc = preview('display');                                                                                                                                                                                                             
   submit sql continue;                                                                                                                                                                                                                                         
      ;                                                                                                                                                                                                                                                         
   endsubmit;                                                                                                                                                                                                                                                   
   return(symgetn('sqlrc'));                                                                                                                                                                                                                                    
endmethod;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
dsid_info : method                                                                                                                                                                                                                                              
   dsid : i : num                                                                                                                                                                                                                                               
   return=list;                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                
   dcl num i rc;                                                                                                                                                                                                                                                
   dcl list outlist = makelist(); rc=setlattr(outlist,'honorcase');                                                                                                                                                                                             
   dcl list thisvar;                                                                                                                                                                                                                                            
   do i = 1 to attrn(dsid,'nvars');                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                
      /* create a blank list named item for the variable */                                                                                                                                                                                                     
      rc = insertl(outlist,makelist(),i,varname(dsid,i));                                                                                                                                                                                                       
      thisvar = getiteml(outlist,i);                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                
      rc = insertc(thisvar,vartype(dsid,i),-1,'type');                                                                                                                                                                                                          
      rc = insertc(thisvar,varfmt(dsid,i),-1,'fmt');                                                                                                                                                                                                            
      rc = insertn(thisvar,varlen(dsid,i),-1,'len');                                                                                                                                                                                                            
   end;                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                
return(outlist);                                                                                                                                                                                                                                                
endmethod;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
dsid_info : method                                                                                                                                                                                                                                              
   ds : i : char                                                                                                                                                                                                                                                
   return = list;                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                
   dcl num  dsid = open(ds);                                                                                                                                                                                                                                    
   dcl list outlist = dsid_info(dsid);                                                                                                                                                                                                                          
   dcl      num rc = close(dsid);                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                
   return(outlist);                                                                                                                                                                                                                                             
endmethod;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
info : method                                                                                                                                                                                                                                                   
   dsid : i : num                                                                                                                                                                                                                                               
   return=list;                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                
   return(dsid_info(dsid));                                                                                                                                                                                                                                     
endmethod;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
info : method                                                                                                                                                                                                                                                   
   ds : i : char                                                                                                                                                                                                                                                
   return = list;                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                
   return(dsid_info(ds));                                                                                                                                                                                                                                       
endmethod;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                
extend : method                                                                                                                                                                                                                                                 
   ds   : i : list                                                                                                                                                                                                                                              
   keys : i : char                                                                                                                                                                                                                                              
   ;                                                                                                                                                                                                                                                            
   control asis;                                                                                                                                                                                                                                                
   dcl num dsid j rc;                                                                                                                                                                                                                                           
   dcl char outds = getitemc(ds,1);                                                                                                                                                                                                                             
   dcl char thisds;                                                                                                                                                                                                                                             
   dcl char keysdelim = tranwrd(keys,' ',',');                                                                                                                                                                                                                  
   dcl num  keyscount = countw(keysdelim);                                                                                                                                                                                                                      
   dcl sashelp.classes.sclexception.class excp = _new_ sashelp.classes.sclexception();                                                                                                                                                                          
                                                                                                                                                                                                                                                                
   if ^exist(outds) then do;              * allow for a new dataset to the be the target of   ;                                                                                                                                                                 
      dsid = open(outds,'n');             * extension by creating a zero-obs, zero-variable   ;                                                                                                                                                                 
      rc = close(dsid);                   * dataset as the starting point                     ;                                                                                                                                                                 
   end;                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                
   do;                                    * first, make a copy of the backup dataset          ;                                                                                                                                                                 
      rc = copy(outds,'work.__backup');   * can't throw exception here as it would trigger a  ;                                                                                                                                                                 
      if rc ne 0 then return;             * restoration from backup, which doesn't exist yet  ;                                                                                                                                                                 
                                          * then, create a union of all columns that are      ;                                                                                                                                                                 
                                          * on all datasets - this means that if there are    ;                                                                                                                                                                 
      submit;                                                                                                                                                                                                                                                   
         data &outds; if 0 then set                                                                                                                                                                                                                             
      endsubmit;                          * conflicting labels, the last label in will over-  ;                                                                                                                                                                 
                                          * ride all the others. it appears that this process ;                                                                                                                                                                 
      do j = 2 to listlen(ds);            * will maintain the longest length found for over-  ;                                                                                                                                                                 
         thisds = getitemc(ds,j);         * lapping names                                     ;                                                                                                                                                                 
         submit;                                                                                                                                                                                                                                                
            &thisds                                                                                                                                                                                                                                             
         endsubmit;                                                                                                                                                                                                                                             
      end;                                                                                                                                                                                                                                                      
      submit continue;                                                                                                                                                                                                                                          
         ; set &outds; run;                                                                                                                                                                                                                                     
      endsubmit;                                                                                                                                                                                                                                                
      if symgetn('syserr') > 0 then throw excp;                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                
      * now, for each dataset, run a modify - this means  ;                                                                                                                                                                                                     
      * that where the keys match, the last dataset in    ;                                                                                                                                                                                                     
      * will override anything else - unless the key is   ;                                                                                                                                                                                                     
      * blank                                             ;                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                
      if keys ne '_STRUCTURE_' then do j = 2 to listlen(ds);                                                                                                                                                                                                    
         thisds = getitemc(ds,j);                                                                                                                                                                                                                               
         submit continue;                                                                                                                                                                                                                                       
         data &outds;                                                                                                                                                                                                                                           
            modify &outds &thisds;                                                                                                                                                                                                                              
            by &keys;                                                                                                                                                                                                                                           
            select(_iorc_);                                                                                                                                                                                                                                     
               when (%sysrc(_sok))    do; if cmiss(&keysdelim) = &keyscount then output; else replace; end;                                                                                                                                                     
               when (%sysrc(_dsenmr)) do; _error_ = 0; output; end;                                                                                                                                                                                             
               when (%sysrc(_dsemtr)) do; _error_ = 0; output; end;                                                                                                                                                                                             
               otherwise              do; put 'ERROR: Update transaction failed. IORC is ' _iorc_; end;                                                                                                                                                         
            end;                                                                                                                                                                                                                                                
         run;                                                                                                                                                                                                                                                   
         endsubmit;                                                                                                                                                                                                                                             
         if symgetn('syserr') then throw excp;                                                                                                                                                                                                                  
      end;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
      catch excp;                                                                                                                                                                                                                                               
         * restore data back to original state ;                                                                                                                                                                                                                
         rc = copy('work.__backup',outds);                                                                                                                                                                                                                      
         if rc = 0 then rc = delete('work.__backup');                                                                                                                                                                                                           
         throw excp;                                                                                                                                                                                                                                            
      endcatch;                                                                                                                                                                                                                                                 
   end;                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                
endmethod;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                
compare_structure : method                                                                                                                                                                                                                                      
   base : i : char                                                                                                                                                                                                                                              
   comp : i : char                                                                                                                                                                                                                                              
   return = list ;                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                
   dcl num rc comp_rc idx;                                                                                                                                                                                                                                      
   dcl char thisname;                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                
   dcl list base_info = dsid_info(base);                                                                                                                                                                                                                        
   dcl list comp_info = dsid_info(comp);                                                                                                                                                                                                                        
   dcl list both_same = makelist(); rc=setlattr(both_same,'honorcase');                                                                                                                                                                                         
   dcl list both_diff = makelist(); rc=setlattr(both_diff,'honorcase');                                                                                                                                                                                         
   dcl list base_copy = makelist(); rc=setlattr(base_copy,'honorcase');                                                                                                                                                                                         
                                                                                                                                                                                                                                                                
   dcl list thislist thiscomp sublist;                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                
   dcl list outlist = makelist(); rc=setlattr(outlist,'honorcase');                                                                                                                                                                                             
   rc = insertl(outlist,base_copy,-1,'BASE');                                                                                                                                                                                                                   
   rc = insertl(outlist,comp_info,-1,'COMP');                                                                                                                                                                                                                   
   rc = insertl(outlist,both_same,-1,'SAME');                                                                                                                                                                                                                   
   rc = insertl(outlist,both_diff,-1,'DIFF');                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                
   do while(listlen(base_info));                                       * works easier as a one-and-done to pop ;                                                                                                                                                
                                                                                                                                                                                                                                                                
      thisname = nameitem(base_info);                                  * store the name of the current variable;                                                                                                                                                
      thislist = popl(base_info);                                      * and make it's info the current list;                                                                                                                                                   
                                                                                                                                                                                                                                                                
      idx = nameditem(comp_info,thisname);                             * if there's no analogue on the comp list;                                                                                                                                               
      if idx = 0 then rc = insertl(base_copy,thislist,-1,thisname);    * put the variable in the 'base only' pile ;                                                                                                                                             
      else do;                                                         * otherwise;                                                                                                                                                                             
         thiscomp = popl(comp_info,idx);                               * get the variable's info from the comparison dataset;                                                                                                                                   
         comp_rc = comparelist(thislist,thiscomp);                     * and compare it to to the info of the base variable;                                                                                                                                    
         if comp_rc = 0 then insertl(both_same,thislist,-1,thisname);  * if they're the same, throw it on the 'same' pile;                                                                                                                                      
         else do;                                                      * but if not ;                                                                                                                                                                           
            rc = insertl(both_diff,makelist(),-1,thisname);            * store the same-named but differently defined;                                                                                                                                          
            sublist = getiteml(both_diff,-1);                          * variables in the differences pile;                                                                                                                                                     
            rc = insertl(sublist,thislist,-1,'BASE');                                                                                                                                                                                                           
            rc = insertl(sublist,thiscomp,-1,'COMP');                                                                                                                                                                                                           
         end;                                                                                                                                                                                                                                                   
      end;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
   end;                                                                                                                                                                                                                                                         
   rc = dellist(base_info);                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                
return(outlist);                                                                                                                                                                                                                                                
endmethod;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
compare_datasets : method                                                                                                                                                                                                                                       
      datasets : i : list                                                                                                                                                                                                                                       
      vars     : i : list                                                                                                                                                                                                                                       
      out      : o : list                                                                                                                                                                                                                                       
      ;                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                
dcl num i;                                                                                                                                                                                                                                                      
control asis;                                                                                                                                                                                                                                                   
* condense the variables into a single string - these will be used in the submit block ;                                                                                                                                                                        
dcl char(1024) var_str var_str2; dcl char this_var;                                                                                                                                                                                                             
do i = 1 to listlen(vars);                                                                                                                                                                                                                                      
   this_var = getitemc(vars,i);                                                                                                                                                                                                                                 
   var_str = catx(',',var_str,quote(this_var));                                                                                                                                                                                                                 
   var_str2 = catx(' ',var_str2,this_var);                                                                                                                                                                                                                      
end;                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                
* get the datasets to compare ;                                                                                                                                                                                                                                 
dcl char ds1 = getitemc(datasets,1);                                                                                                                                                                                                                            
dcl char ds2 = getitemc(datasets,2);                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                
dcl char out1 = getitemc(out,1);                                                                                                                                                                                                                                
dcl char out2 = getitemc(out,2);                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                
* just a giant submit block ! uses SAS Data Step Hash Component Object - which isn't available in SCL! Sure.;                                                                                                                                                   
                                                                                                                                                                                                                                                                
submit continue;                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                
data __t1;                                                                                                                                                                                                                                                      
    set &ds1;                                                                                                                                                                                                                                                   
    _order1_ = _n_;                                                                                                                                                                                                                                             
    __a_order = _n_;                                                                                                                                                                                                                                            
    keep _order1_ __a_order &var_str2;                                                                                                                                                                                                                          
run;                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                
data __t2;                                                                                                                                                                                                                                                      
    set &ds2;                                                                                                                                                                                                                                                   
    _order2_ = _n_;                                                                                                                                                                                                                                             
    __a_order = _n_;                                                                                                                                                                                                                                            
    keep _order2_ __a_order &var_str2;                                                                                                                                                                                                                          
run;                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                
data &out1 &out2;                                                                                                                                                                                                                                               
format _order1_ _order2_ __a_order 8. _status_ $16.;                                                                                                                                                                                                            
* define the hashes;                                                                                                                                                                                                                                            
if _n_ = 1 then do;                                                                                                                                                                                                                                             
    * define 'unmatched' hashes for each file, as well as an 'matched' hash;                                                                                                                                                                                    
    declare hash hash1();                                                                                                                                                                                                                                       
    declare hash hash2();                                                                                                                                                                                                                                       
    declare hash hashm();                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                
    __rc = hash1.definekey(&var_str);                                                                                                                                                                                                                           
    __rc = hash2.definekey(&var_str);                                                                                                                                                                                                                           
    __rc = hashm.definekey(&var_str);                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                
    * define the extra data that will come across ;                                                                                                                                                                                                             
    __rc = hash1.definedata('_order1_');             /* first hash gets first order */                                                                                                                                                                          
    __rc = hash2.definedata('_order2_');             /* second hash gets second order */                                                                                                                                                                        
    __rc = hashm.definedata('_order1_', '_order2_'); /* matched hash gets both */                                                                                                                                                                               
                                                                                                                                                                                                                                                                
    * and we're done!;                                                                                                                                                                                                                                          
    __rc = hash1.definedone();                                                                                                                                                                                                                                  
    __rc = hash2.definedone();                                                                                                                                                                                                                                  
    __rc = hashm.definedone();                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                
    * also note how many records are in each file ;                                                                                                                                                                                                             
    __dsid1  = open('__t1');                                                                                                                                                                                                                                    
    __nobs1  = attrn(__dsid1,'nobs');                                                                                                                                                                                                                           
    __dsidc1 = close(__dsid1);                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                
    __dsid2  = open('__t1');                                                                                                                                                                                                                                    
    __nobs2  = attrn(__dsid2,'nobs');                                                                                                                                                                                                                           
    __dsidc2 = close(__dsid2);                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                
end;                                                                                                                                                                                                                                                            
_status_ = '';                                                                                                                                                                                                                                                  
* duplicate key values are unceremoniously dumped by the hash object - ;                                                                                                                                                                                        
* we need to make sure that they are preserved somehow ;                                                                                                                                                                                                        
/*-----------------------------------------------------------------------------------------------*/                                                                                                                                                             
do until (eof1);                                                                                                                                                                                                                                                
    set __t1 end=eof1;                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                
    /* could use FIND here to update the a_order to match the order of the original */                                                                                                                                                                          
    __rc1_f = hash1.check();              /* check to see if this already exists */                                                                                                                                                                             
    if __rc1_f eq 0 then do;              /* if it's a dup, */                                                                                                                                                                                                  
        _status_ = 'DUP';                 /* note it as such */                                                                                                                                                                                                 
        output &out1;                     /* and output now */                                                                                                                                                                                                  
    end;                                                                                                                                                                                                                                                        
    else do;                              /* if it's a unique value that _can_ be hashed */                                                                                                                                                                     
        _status_ = '';                    /* make sure that the status looks okay */                                                                                                                                                                            
        __rc1_a = hash1.add();            /* and add it to the unmatched hash1 table */                                                                                                                                                                         
    end;                                                                                                                                                                                                                                                        
end;                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                
/*-----------------------------------------------------------------------------------------------*/                                                                                                                                                             
if __nobs2 > 0 then do until (eof2);                                                                                                                                                                                                                            
    set __t2 end=eof2;                                                                                                                                                                                                                                          
    _order1_ = .;                                                                                                                                                                                                                                               
    __rc2_f = hash2.check();              /* check to see if this already exists */                                                                                                                                                                             
    if __rc2_f eq 0 then do;              /* if it's a dup, */                                                                                                                                                                                                  
        _status_ = 'DUP';                 /* note it as such */                                                                                                                                                                                                 
        output &out2;                     /* and output now */                                                                                                                                                                                                  
    end;                                                                                                                                                                                                                                                        
    else do;                              /* if it's a unique value that _can_ be hashed */                                                                                                                                                                     
        _status_ = '';                    /* make sure that the status looks okay */                                                                                                                                                                            
        __rc2_a = hash2.add();            /* and add it to the unmatched hash table */                                                                                                                                                                          
                                                                                                                                                                                                                                                                
        /* now, since this is the second file, there's a chance that this record has a match */                                                                                                                                                                 
        /*  on the first file - which we can determine by checking the hash */                                                                                                                                                                                  
        __rc1_f = hash1.find();           /* try to bring in _order1_ from the first hash */                                                                                                                                                                    
        if __rc1_f eq 0 then do;          /* if it's there, classify this record as 'matched' by */                                                                                                                                                             
            __rc1_a = hashm.add();        /* adding the record to the matched hash */                                                                                                                                                                           
            __rc1_r = hash1.remove();     /* and removing it from the unmatched hash1 */                                                                                                                                                                        
            /*xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx*/                                                                                                                                                            
            *__rc2_r = hash2.remove();    /* DON'T remove from hash2 at this point - we still need*/                                                                                                                                                            
                                          /* to check against this hash for potential dups        */                                                                                                                                                            
            /*xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx*/                                                                                                                                                            
        end;                                                                                                                                                                                                                                                    
    end;                                                                                                                                                                                                                                                        
end;                                                                                                                                                                                                                                                            
/*-----------------------------------------------------------------------------------------------*/                                                                                                                                                             
                                                                                                                                                                                                                                                                
/* reset the end-of-file markers */                                                                                                                                                                                                                             
eof1=0; eof2=0;                                                                                                                                                                                                                                                 
do until (eof1 and eof2);                                                                                                                                                                                                                                       
    set __t1(in=__t1) end=eof1                                                                                                                                                                                                                                  
        __t2(in=__t2) end=eof2;                /* now, we'll go through the datasets again, */                                                                                                                                                                  
    by __a_order;                              /* in an interleaved fashion                 */                                                                                                                                                                  
                                               /* MSP 2014-08-25 - why? may not need to     */                                                                                                                                                                  
    _status_ = '';                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                
    __rc1_f = hash1.find();                     /* look for the record on all three hashtables */                                                                                                                                                               
    __rc2_f = hash2.find();                     /* first, the unmatched ones, */                                                                                                                                                                                
    __rcm_f = hashm.find();                     /* then the matched one - this will overwrite both orders */                                                                                                                                                    
                                                                                                                                                                                                                                                                
    if __rcm_f = 0 then do;                     /* if it's a matched record */                                                                                                                                                                                  
        _status_ = 'MATCH';                     /* classify it as such and output both to both files */                                                                                                                                                         
        output &out1 &out2;                     /* then remove the record from the matched hash */                                                                                                                                                              
        __rcr_m = hashm.remove();               /* and from the unmatched hash2 - which we had to */                                                                                                                                                            
        __rcr_2 = hash2.remove();               /* keep around to checks for hash2 dups above */                                                                                                                                                                
    end;                                                                                                                                                                                                                                                        
    else if (__t1 and __rc1_f = 0) then do;     /* if it's only in the unmatched hash1, note that */                                                                                                                                                            
        _status_ = 'NOMATCH';                                                                                                                                                                                                                                   
        output &out1;                                                                                                                                                                                                                                           
        __rc1_r = hash1.remove();               /* and pull it from the hashtable */                                                                                                                                                                            
    end;                                                                                                                                                                                                                                                        
    else if (__t2 and __rc2_f = 0) then do;     /* same for unmatched hash2 */                                                                                                                                                                                  
        _status_ = 'NOMATCH';                                                                                                                                                                                                                                   
        output &out2;                                                                                                                                                                                                                                           
        __rc2_r = hash2.remove();                                                                                                                                                                                                                               
    end;                                                                                                                                                                                                                                                        
    else do;                                                                                                                                                                                                                                                    
        _status_ = 'REMOVED';                                                                                                                                                                                                                                   
        /*xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx*/                                                                                                                                                                
        *output;    /* DON'T output here - all matched records are evaluated twice (once from */                                                                                                                                                                
                    /* each file) and we explicitly removed them from the hashes above to make*/                                                                                                                                                                
                    /* sure we don't output duplicates                                        */                                                                                                                                                                
        /*xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx*/                                                                                                                                                                
    end;                                                                                                                                                                                                                                                        
end;                                                                                                                                                                                                                                                            
drop __:;                                                                                                                                                                                                                                                       
run;                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                
proc sort data=&out1 out=&out1(drop=_order1_ rename=(_order2_=_order_)) ; by _order1_; run;                                                                                                                                                                     
proc sort data=&out2 out=&out2(drop=_order2_ rename=(_order1_=_order_)) ; by _order2_; run;                                                                                                                                                                     
                                                                                                                                                                                                                                                                
data &out1; format _dscomp_ $41.; set &out1; _dscomp_ = upcase("&out2"); run;                                                                                                                                                                                   
data &out2; format _dscomp_ $41.; set &out2; _dscomp_ = upcase("&out1"); run;                                                                                                                                                                                   
                                                                                                                                                                                                                                                                
proc datasets nolist nowarn lib=work; delete __t1 __t2; run; quit;                                                                                                                                                                                              
                                                                                                                                                                                                                                                                
endsubmit;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
endmethod;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
classify_nomatch : method                                                                                                                                                                                                                                       
      args : i : list                                                                                                                                                                                                                                           
      ;                                                                                                                                                                                                                                                         
dcl char  ds = getnitemc(args,'ds');                  /* need the actual dataset to update */                                                                                                                                                                   
dcl char _otherDSN   = getnitemc(args,'comp');                                                                                                                                                                                                                  
dcl char _orderName  = getnitemc(args,'order');                                                                                                                                                                                                                 
dcl char _statusName = getnitemc(args,'status');                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                
dcl char mode type _status;                                                                                                                                                                                                                                     
dcl num rc j k noteid _order _lastOrder dsid _nobs _otherNobs;                                                                                                                                                                                                  
call putlist(args);                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                
    dsid = open(_otherDSN);                                                                                                                                                                                                                                     
    _otherNobs = attrn(dsid,'nobs');                                                                                                                                                                                                                            
    rc = close(dsid);                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                
    dsid = open(ds,'u');                                                                                                                                                                                                                                        
    _nobs = attrn(dsid,'nobs');                                                                                                                                                                                                                                 
    mode = 'READ';                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                
    dcl num _orderVar   = varnum(dsid,_orderName);                                                                                                                                                                                                              
    dcl num _statusVar  = varnum(dsid,_statusName);                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                
    do while(fetch(dsid) = 0);                                                                                                                                                                                                                                  
        if mode = 'READ' then do;                                                                                                                                                                                                                               
            k = 0;                                                                                                                                                                                                                                              
            *j = curobs(dsid);                                                                                                                                                                                                                                  
            if curobs(dsid) = 1 then do;                                                                                                                                                                                                                        
               noteid = note(dsid);                      /* create a first note - need it */                                                                                                                                                                    
               _lastOrder = 0;                                                                                                                                                                                                                                  
               *put j= _lastOrder= noteid=;                                                                                                                                                                                                                     
            end;                                                                                                                                                                                                                                                
            _order = getvarn(dsid,_orderVar);                                                                                                                                                                                                                   
            if _order ne . then do;               /* if the current obs has an order2, re-note it */                                                                                                                                                            
                rc = dropnote(dsid,noteid);                                                                                                                                                                                                                     
                noteid = note(dsid);                                                                                                                                                                                                                            
                *put dsid= noteid=;                                                                                                                                                                                                                             
                _lastOrder = getvarn(dsid,_orderVar);                                                                                                                                                                                                           
                *put j= 'NOTING' _lastOrder=;                                                                                                                                                                                                                   
            end;                                                                                                                                                                                                                                                
               /* could be problematic here if we get to the end of the file and we're sitting with  */                                                                                                                                                         
               /* some mismatches                                                                    */                                                                                                                                                         
            else do until(_order ne . or rc = -1);                                                                                                                                                                                                              
                k+1;                                                                                                                                                                                                                                            
               j = curobs(dsid);                                                                                                                                                                                                                                
                _order = getvarn(dsid,_orderVar);                                                                                                                                                                                                               
               if _order = . and curobs(dsid) = _nobs then _order = _nobs;                                                                                                                                                                                      
               put j= k= _lastOrder= _order= _otherNobs=;                                                                                                                                                                                                       
                /* this is really the heart of the classifier */                                                                                                                                                                                                
                if j gt _otherNobs then do;                                                                                                                                                                                                                     
                  type = 'INSERT';                                                                                                                                                                                                                              
                  mode = 'WRITE';                                                                                                                                                                                                                               
                end;                                                                                                                                                                                                                                            
                else if _order - _lastOrder = k then do;  /* if the other file has exactly the same size gap as  */                                                                                                                                             
                  type = 'DIFF';                          /* the number of records read in from the file, assume */                                                                                                                                             
                  mode = 'WRITE'; put type= mode=;                         /* that's because the records are different, but their */                                                                                                                            
               end;                                       /* relative ordering should still be the same          */                                                                                                                                             
                                                                                                                                                                                                                                                                
                else if _order - _lastOrder = 1 then do;  /* or, if there are nonmatched records on _this_ file, */                                                                                                                                             
                  type = 'INSERT';                        /* but no gap whatsoever on _that_ file, assume that   */                                                                                                                                             
                  mode = 'WRITE';                         /* whatever records are on _this_ file are insertions  */                                                                                                                                             
                end;                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                
                else do;                                                                                                                                                                                                                                        
                  type = 'NOMATCH';                                                                                                                                                                                                                             
                  mode = 'WRITE';                                                                                                                                                                                                                               
               end;                                                                                                                                                                                                                                             
               rc = fetch(dsid);                                                                                                                                                                                                                                
            end;                                                                                                                                                                                                                                                
        end;                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                
        if mode = 'WRITE' then do;                                                                                                                                                                                                                              
            put mode= type=;                                                                                                                                                                                                                                    
            k=0;                                                                                                                                                                                                                                                
            rc = point(dsid,noteid);                    /* re-position the pointer on the last record with an  */                                                                                                                                               
            rc = fetch(dsid);  put 'fetch' rc=;                         /* order - or maybe the first record on the file. read */                                                                                                                               
            if _lastOrder ne 0 then rc = fetch(dsid); /* it, and if it's not the first record, then read the */                                                                                                                                                 
            put 'fetch2' rc=;                         /* next record - the first one with no order */                                                                                                                                                           
                                                                                                                                                                                                                                                                
            _order  = getvarn(dsid,_orderVar);          /* we know there is no order from above, so we can use */                                                                                                                                               
            _status = getvarc(dsid,_statusVar);         /* that to initialize the while loop below */                                                                                                                                                           
            put 'startloop' _order= _status= rc=;                                                                                                                                                                                                               
            /* while reading in nonmatched records */                                                                                                                                                                                                           
            do while (_order = . and rc = 0);                                                                                                                                                                                                                   
                k+1; put 'WRITELOOP' k=;                                                                                                                                                                                                                        
               /* update the records based on whether the classifier thinks it's an insert or a diff */                                                                                                                                                         
               /* an insert always gets an other order of -1. a diff tries to compute the observation */                                                                                                                                                        
               /* number to compare to on the other file */                                                                                                                                                                                                     
               select(type);                                                                                                                                                                                                                                    
                  when('INSERT')  call putvarn(dsid,_orderVar,-1);                                                                                                                                                                                              
                  when('DIFF')    call putvarn(dsid,_orderVar,_lastOrder+k);                                                                                                                                                                                    
                  when('NOMATCH') call putvarn(dsid,_orderVar,0); put 'NOMATCH' k= _lastOrder=;                                                                                                                                                                 
                end;                                                                                                                                                                                                                                            
                call putvarc(dsid,_statusVar,type);                                                                                                                                                                                                             
                rc = update(dsid);                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                
                * FOR DEBUG ;                                                                                                                                                                                                                                   
                j = curobs(dsid);                                                                                                                                                                                                                               
                put j= 'REPLACED' _status= 'with' type;                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                
                rc = fetch(dsid);                                                                                                                                                                                                                               
                if rc ne -1 then do;                                                                                                                                                                                                                            
                _order  = getvarn(dsid,_orderVar);  /* read in the next unmatched record */                                                                                                                                                                     
                _status = getvarc(dsid,_statusVar);                                                                                                                                                                                                             
               end;                                                                                                                                                                                                                                             
            end;                                                                                                                                                                                                                                                
            /* once finished with nonmatched records, return the dataset pointer to the last known */                                                                                                                                                           
            /* record that had an order not filled in by the logic above, and return to read mode  */                                                                                                                                                           
            rc = point(dsid,noteid);                                                                                                                                                                                                                            
            mode = 'READ';                                                                                                                                                                                                                                      
        end;                                                                                                                                                                                                                                                    
    end;                                                                                                                                                                                                                                                        
    rc = close(dsid);                                                                                                                                                                                                                                           
endmethod;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                
compare_data_to_dsid_info : method                                                                                                                                                                                                                              
   data      : i : list /* new data from a list                          */                                                                                                                                                                                     
   dsid_info : i : list /* list that is output from the dsid_info method */                                                                                                                                                                                     
   return=list                                                                                                                                                                                                                                                  
   ;                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                
   dcl num i rc idx;                                                                                                                                                                                                                                            
   dcl char data_name data_type dsid_info_type dsid_info_fmt;                                                                                                                                                                                                   
   dcl num dsid_info_len data_len;                                                                                                                                                                                                                              
   dcl list dsid_info_var;                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
   /* sort of hacky - we're going to build a list structure _inside_ the outlist          */                                                                                                                                                                    
   /* and we're going to set a change flag for each modification type. if a given change  */                                                                                                                                                                    
   /* flag is never tripped, we'll blank out the list associated with that change type    */                                                                                                                                                                    
   dcl list outlist   = makelist(); rc=setlattr(outlist,'honorcase');                                                                                                                                                                                           
   dcl list addlist   = makelist(); rc=setlattr(addlist,'honorcase');                                                                                                                                                                                           
   dcl list modlist   = makelist(); rc=setlattr(modlist,'honorcase');                                                                                                                                                                                           
   rc = insertl(outlist,addlist,-1,'add');                                                                                                                                                                                                                      
   rc = insertl(outlist,modlist,-1,'modify');                                                                                                                                                                                                                   
   dcl list comp_item = makelist(); rc=setlattr(outlist,'honorcase');                                                                                                                                                                                           
   do i = 1 to listlen(data);                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                
      /* clear out the list that will hold the comparison info */                                                                                                                                                                                               
      rc = clearlist(comp_item,'Y');                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                
      /* examine the incoming data - if it doesn't have an analogue on the dataset, note it */                                                                                                                                                                  
      data_name = nameitem(data,i);                                                                                                                                                                                                                             
      data_type = itemtype(data,i);                                                                                                                                                                                                                             
      idx = nameditem(dsid_info,data_name);                                                                                                                                                                                                                     
      if idx = 0 then do;                                                                                                                                                                                                                                       
         select(data_type);                                                                                                                                                                                                                                     
            when('N') rc = insertn(addlist,8,-1,data_name);                                                                                                                                                                                                     
            * MSP 2014-08-25 - changed from insertc - don't know why it was that way ;                                                                                                                                                                          
            when('C') rc = insertn(addlist,length(getitemc(data,i)),-1,data_name);                                                                                                                                                                              
         end;                                                                                                                                                                                                                                                   
      end;                                                                                                                                                                                                                                                      
      else do;                                                                                                                                                                                                                                                  
         dsid_info_var = getiteml(dsid_info,idx);                                                                                                                                                                                                               
         /* this logic makes two assumptions:                                                  */                                                                                                                                                               
         /*    1. that numeric variables always have length 8 and never need to be lengthened  */                                                                                                                                                               
         /*    2. that character variables in the list representing a numeric date/time format */                                                                                                                                                               
         /*       on the dataset don't need any sort of processing                             */                                                                                                                                                               
         select(data_type);                                                                                                                                                                                                                                     
            when('N') continue;                                                                                                                                                                                                                                 
            when('C') do;                                                                                                                                                                                                                                       
               /* need to look up the type and format in the template */                                                                                                                                                                                        
               dsid_info_type = getnitemc( dsid_info_var,'type' );                                                                                                                                                                                              
               dsid_info_fmt  = getnitemc( dsid_info_var,'fmt'  );                                                                                                                                                                                              
               dsid_info_len  = getnitemn( dsid_info_var,'len'  );                                                                                                                                                                                              
               if (dsid_info_type = 'N' and prxmatch(datetime_regex,dsid_info_fmt) > 0) then continue;                                                                                                                                                          
               else do;                                                                                                                                                                                                                                         
                  data_len  = length(getitemc(data,i));                                                                                                                                                                                                         
                  if data_len > dsid_info_len then do;                                                                                                                                                                                                          
                     rc = insertn(modlist,data_len,-1,data_name);                                                                                                                                                                                               
                  end;                                                                                                                                                                                                                                          
               end;                                                                                                                                                                                                                                             
            end;                                                                                                                                                                                                                                                
         end;                                                                                                                                                                                                                                                   
      end;                                                                                                                                                                                                                                                      
      *call putlist(outlist,'list now=',0);                                                                                                                                                                                                                     
   /* data list */                                                                                                                                                                                                                                              
   end;                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                
   if listlen(addlist) = 0 then do;                                                                                                                                                                                                                             
      outlist = delnitem(outlist,'add');                                                                                                                                                                                                                        
      dellist(addlist,'Y');                                                                                                                                                                                                                                     
   end;                                                                                                                                                                                                                                                         
   if listlen(modlist) = 0 then do;                                                                                                                                                                                                                             
      outlist = delnitem(outlist,'modify');                                                                                                                                                                                                                     
      dellist(modlist,'Y');                                                                                                                                                                                                                                     
   end;                                                                                                                                                                                                                                                         
   return(outlist);                                                                                                                                                                                                                                             
endmethod;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
map_to_dsid : method                                                                                                                                                                                                                                            
   list : i : num  /* a list of items to be written - named */                                                                                                                                                                                                  
   dsid : i : num  /* a dataset identifier for a table already opened in update mode */                                                                                                                                                                         
   optional=                                                                                                                                                                                                                                                    
      op : i : list                                                                                                                                                                                                                                             
   return=num                                                                                                                                                                                                                                                   
   ;                                                                                                                                                                                                                                                            
   dcl num  v_num;                                                                                                                                                                                                                                              
   dcl char i_name i_type v_type v_fmt;                                                                                                                                                                                                                         
   dcl char(32767) curr_char_val;                                                                                                                                                                                                                               
   dcl char upc lowc alter;                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                
   upc     = 'f';      /* upcase whatever comes in */                                                                                                                                                                                                           
   lowc    = 'f';      /* lowcase whatever comes in */                                                                                                                                                                                                          
   alter   = 'f';      /* can we alter this table ? */                                                                                                                                                                                                          
   if ^cmiss(op) then do;                                                                                                                                                                                                                                       
      upc      = lowcase(first(getnitemc(op,'upcase',1,1,'f')));                                                                                                                                                                                                
      lowc     = lowcase(first(getnitemc(op,'lowcase',1,1,'f')));                                                                                                                                                                                               
      alter    = lowcase(first(getnitemc(op,'alter',1,1,'f')));                                                                                                                                                                                                 
   end;                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                
   do while(listlen(list));                                                                                                                                                                                                                                     
      *call putlist(list,'the-list-is=',0);                                                                                                                                                                                                                     
      /* first, get the item's name - then figure out what it needs on the dataset */                                                                                                                                                                           
      i_name = nameitem(list);                                                                                                                                                                                                                                  
      i_type = itemtype(list);                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                
      v_num  = varnum(dsid,i_name);                                                                                                                                                                                                                             
      if v_num = 0 and alter = 'f' then do;                                                                                                                                                                                                                     
         select(i_type);                                                                                                                                                                                                                                        
            when('C') popc(list);                                                                                                                                                                                                                               
            when('N') popn(list);                                                                                                                                                                                                                               
         end;                                                                                                                                                                                                                                                   
      end;                                                                                                                                                                                                                                                      
      else do;                                                                                                                                                                                                                                                  
         v_type = vartype(dsid,v_num);                                                                                                                                                                                                                          
         v_fmt  = varfmt(dsid,v_num);                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                
         select(i_type);                                                                                                                                                                                                                                        
            /* this is almost guarenteed to break for friggin dates and times - ugh, sas! */                                                                                                                                                                    
            when('C') do;                                                                                                                                                                                                                                       
               /* include some special handling for list char items _TRUE_, _FALSE_, and _NULL_ */                                                                                                                                                              
               /* in particular, just pop the null value off of the list but don't do anything  */                                                                                                                                                              
               /* with it                                                                       */                                                                                                                                                              
               curr_char_val = popc(list);                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
               if upc  = 't' then curr_char_val = upcase(curr_char_val);                                                                                                                                                                                        
               if lowc = 't' and curr_char_val not in ('_TRUE_', '_FALSE_', '_NULL_')                                                                                                                                                                           
                  then curr_char_val = lowcase(curr_char_val);                                                                                                                                                                                                  
               if curr_char_val = '_NULL_' then do;                                                                                                                                                                                                             
                  if (v_type = 'N') then call putvarn(dsid,v_num,.);                                                                                                                                                                                            
                  else                   call putvarc(dsid,v_num,'');                                                                                                                                                                                           
               end;                                                                                                                                                                                                                                             
               else do;                                                                                                                                                                                                                                         
                  if (v_type = 'N' and prxmatch(datetime_regex,v_fmt) > 0) then                                                                                                                                                                                 
                     call putvarn(dsid,v_num,inputn(curr_char_val,v_fmt));                                                                                                                                                                                      
                  else call putvarc(dsid,v_num,curr_char_val);                                                                                                                                                                                                  
               end;                                                                                                                                                                                                                                             
            end;                                                                                                                                                                                                                                                
            when('N') call putvarn(dsid,v_num,popn(list));                                                                                                                                                                                                      
            otherwise return(-999999);                                                                                                                                                                                                                          
         end;                                                                                                                                                                                                                                                   
      end;                                                                                                                                                                                                                                                      
   end;                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                
   return(0);                                                                                                                                                                                                                                                   
endmethod;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
write : method                                                                                                                                                                                                                                                  
   data       : i : list                                                                                                                                                                                                                                        
   ds         : i : char                                                                                                                                                                                                                                        
   optional=                                                                                                                                                                                                                                                    
      map_opt    : i : list                                                                                                                                                                                                                                     
      notify     : i : list                                                                                                                                                                                                                                     
   return=                                                                                                                                                                                                                                                      
      num                                                                                                                                                                                                                                                       
   ;                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                
   dcl num rc dsid i ;                                                                                                                                                                                                                                          
   dcl list info this_data comp_list alt_list;                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                
   dcl char alter = 'f';                                                                                                                                                                                                                                        
   dcl char verbose = 'f';                                                                                                                                                                                                                                      
   if ^cmiss(map_opt) then do;                                                                                                                                                                                                                                  
      alter = getnitemc(map_opt,'alter',1,1,'f');                                                                                                                                                                                                               
      verbose = getnitemc(map_opt,'verbose',1,1,'f');                                                                                                                                                                                                           
   end;                                                                                                                                                                                                                                                         
   if verbose = 't' then call putlist(data,'Writing the following to '!!ds!!'=',0);                                                                                                                                                                             
                                                                                                                                                                                                                                                                
   /* do a quick test on the first item of the list - if it's a character or a number */                                                                                                                                                                        
   /* (that is, not a list) then we'll wrap it in another list and run the remainder  */                                                                                                                                                                        
   /* of the method                                                                   */                                                                                                                                                                        
   if itemtype(data) ne 'L' then do;                                                                                                                                                                                                                            
      dcl list quickcopy = copylist(data,'Y');                                                                                                                                                                                                                  
      rc=clearlist(data,'Y');                                                                                                                                                                                                                                   
      rc=insertl(data,quickcopy);                                                                                                                                                                                                                               
     * rc=dellist(quickcopy);                                                                                                                                                                                                                                   
   end;                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                
   /* open the dataset, get its info, and compare that to what is in the list to be written */                                                                                                                                                                  
   dsid = open(ds,'u');                                                                                                                                                                                                                                         
   info = dsid_info(dsid);                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
   do while(listlen(data));                                                                                                                                                                                                                                     
      this_data = popl(data);                                                                                                                                                                                                                                   
      comp_list = compare_data_to_dsid_info(this_data,info);                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                
      /* if the comparison shows that there are some differences, and we haven't specified that  */                                                                                                                                                             
      /* the dataset should stay as-is, they need to be addressed before writing out data        */                                                                                                                                                             
                                                                                                                                                                                                                                                                
      if listlen(comp_list) > 0 and alter = 't' then do;                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                
         call putlist(comp_list,'comps=',0);                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                
         /* create a list of alter table instructions */                                                                                                                                                                                                        
         alt_list = makelist();                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                
         /* and for now, screw adds - we're only going to worry about modifications to existing columns */                                                                                                                                                      
         dcl num addn = nameditem(comp_list,'add');                                                                                                                                                                                                             
         dcl num modn = nameditem(comp_list,'modify');                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                
         if modn > 0 then do;                                                                                                                                                                                                                                   
            dcl list mods = getiteml(comp_list,modn);                                                                                                                                                                                                           
             do i = 1 to listlen(mods);                                                                                                                                                                                                                         
                 rc = insertc(                                                                                                                                                                                                                                  
                    alt_list,                                                                                                                                                                                                                                   
                    catx(' ','modify',nameitem(mods,i),'char(',getitemn(mods,i),')'),                                                                                                                                                                           
                    -1                                                                                                                                                                                                                                          
                 );                                                                                                                                                                                                                                             
             end;                                                                                                                                                                                                                                               
         end;                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                
         if addn > 0 then do;                                                                                                                                                                                                                                   
            dcl list adds = getiteml(comp_list,addn);                                                                                                                                                                                                           
            do i = 1 to listlen(adds);                                                                                                                                                                                                                          
               select(itemtype(adds,i));                                                                                                                                                                                                                        
                  when('C') rc = insertc(                                                                                                                                                                                                                       
                     alt_list,                                                                                                                                                                                                                                  
                     catx(' ','add',nameitem(adds,i),'char(',getitemc(adds,i),')'),                                                                                                                                                                             
                     -1                                                                                                                                                                                                                                         
                  );                                                                                                                                                                                                                                            
                  when('N') rc = insertc(                                                                                                                                                                                                                       
                     alt_list,                                                                                                                                                                                                                                  
                     catx(' ','add',nameitem(adds,i),'num(',getitemn(adds,i),')'),                                                                                                                                                                              
                     -1                                                                                                                                                                                                                                         
                  );                                                                                                                                                                                                                                            
               end;                                                                                                                                                                                                                                             
            end;                                                                                                                                                                                                                                                
         end;                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                
         /* then alter the dataset - which means we'll need to close it */                                                                                                                                                                                      
         rc   = close(dsid);                                                                                                                                                                                                                                    
         rc   = alter_table(ds,alt_list);                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                
         /* and throw out a notification that we're changing stuff on the dataset */                                                                                                                                                                            
         do i = 1 to listlen(notify);                                                                                                                                                                                                                           
            _sendEvent('column length changed',getitemc(notify,i),comp_list);                                                                                                                                                                                   
         end;                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                
         dsid = open(ds,'u');                                                                                                                                                                                                                                   
         info = dsid_info(dsid);                                                                                                                                                                                                                                
      end;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
      /* now we can map! */                                                                                                                                                                                                                                     
      rc = map_to_dsid(this_data,dsid,map_opt);                                                                                                                                                                                                                 
      rc = append(dsid,'noinit');                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                
   end;                                                                                                                                                                                                                                                         
   rc = close(dsid);                                                                                                                                                                                                                                            
   return(0);                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                
endmethod;                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                
endclass;
